<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìÖ Agenda Gatuna ‚Äì Continua</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-main: #ffeefd;
      --bg-card: #ffffff;
      --bg-soft: #fff7ff;
      --accent-1: #ff9eb5;
      --accent-2: #ffc96b;
      --accent-3: #b4f8c8;
      --accent-4: #a0c4ff;
      --accent-5: #ffadf0;
      --text-main: #3b3b3b;
      --text-soft: #777;
      --border-soft: #f1d4ff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #ffe0f0, #fff7ff 40%, #e7f0ff);
      min-height: 100vh;
      padding: 16px;
      color: var(--text-main);
    }

    .app {
      max-width: 1100px;
      margin: 0 auto 40px;
    }

    /* HEADER */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .title-block {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .cat-logo {
      width: 52px;
      height: 52px;
      border-radius: 18px;
      background: conic-gradient(from 180deg, #ff9eb5, #ffc96b, #b4f8c8, #a0c4ff, #ffadf0, #ff9eb5);
      padding: 3px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cat-inner {
      width: 100%;
      height: 100%;
      border-radius: 14px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
    }

    .title-text h1 {
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .title-text span.badge {
      font-size: 0.75rem;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px dashed rgba(255, 158, 181, 0.7);
      color: #ff6f9c;
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .header-right {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .month-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .month-btn {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.85rem;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .month-label {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      font-size: 0.9rem;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .view-nav {
      display: flex;
      gap: 6px;
      margin-top: 2px;
    }

    .view-btn {
      border: none;
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 0.75rem;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .view-btn.active {
      background: linear-gradient(135deg, #ff9eb5, #ffadf0);
      color: white;
      font-weight: 600;
    }

    /* FORM EVENTO */
    .event-form {
      margin-bottom: 16px;
      padding: 10px 12px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(255, 245, 252, 0.95), rgba(234, 246, 255, 0.95));
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
      border: 1px solid rgba(255, 210, 243, 0.9);
    }

    .event-form-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .event-form-title span.cat {
      font-size: 1.1rem;
    }

    .event-grid {
      display: grid;
      grid-template-columns: 1.4fr 1.4fr;
      gap: 8px;
      margin-bottom: 8px;
    }

    @media (min-width: 700px) {
      .event-grid {
        grid-template-columns: 1.4fr 1.4fr 1.1fr 1.1fr;
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .field label {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .field input[type="text"],
    .field input[type="datetime-local"] {
      border-radius: 999px;
      border: 1px solid #f1d4ff;
      padding: 5px 9px;
      font-size: 0.8rem;
      outline: none;
      background: rgba(255, 255, 255, 0.95);
    }

    .field input[type="datetime-local"] {
      font-size: 0.75rem;
    }

    .color-palette {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .color-swatch {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      cursor: pointer;
      border: 2px solid transparent;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.06);
    }

    .color-swatch.selected {
      border-color: #333;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9);
    }

    .row-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 0.7rem;
    }

    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      border: 1px dashed rgba(176, 144, 255, 0.6);
    }

    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      background: linear-gradient(135deg, #ff9eb5, #ffadf0);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 3px 10px rgba(255, 132, 184, 0.6);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
    }

    .btn-primary span.icon {
      font-size: 1rem;
    }

    .form-hint {
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    /* CONTENEDOR CALENDARIO (cambia seg√∫n vista) */
    .calendar-wrapper {
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.96);
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 10px;
      border: 1px solid rgba(230, 210, 255, 0.7);
      position: relative;
      overflow: hidden;
      min-height: 280px;
    }

    #calendarContainer {
      width: 100%;
      height: 100%;
    }

    /* ==== VISTA MES ==== */
    .weekday-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      margin-bottom: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-soft);
      text-align: center;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .day-cell {
      min-height: 90px;
      background: var(--bg-soft);
      border-radius: 8px;
      border: 1px solid #e4d6ff;
      padding: 3px 3px 4px;
      display: flex;
      flex-direction: column;
      position: relative;
      font-size: 0.7rem;
    }

    .day-cell.empty-day {
      background: rgba(255,255,255,0.7);
      border-style: dashed;
      opacity: 0.6;
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      padding: 0 1px;
    }

    .day-number {
      font-weight: 600;
      font-size: 0.8rem;
    }

    .day-kitty {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .today-badge {
      position: absolute;
      top: 3px;
      right: 3px;
      font-size: 0.55rem;
      padding: 1px 4px;
      border-radius: 999px;
      background: rgba(160, 196, 255, 0.95);
      color: #fff;
      font-weight: 600;
    }

    .day-events {
      position: relative;
      flex: 1;
      padding-top: 2px;
    }

    .month-overlays {
      position: absolute;
      inset: 32px 8px 8px 8px;
      pointer-events: none;
      z-index: 5;
    }

    .overlay-event {
      position: absolute;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      padding: 0 10px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      height: 36px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.12);
    }

    /* ==== VISTA D√çA (HOY) ==== */

    .day-view-header {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .day-view-header span.badge-day {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #ffe4f4;
      color: #d63384;
    }

    .day-hours {
      border-radius: 12px;
      border: 1px dashed #f1d4ff;
      background: #fffafd;
      max-height: 480px;
      overflow-y: auto;
    }

    .hour-row {
      display: grid;
      grid-template-columns: 60px 1fr;
      padding: 4px 8px;
      border-bottom: 1px solid #f6e8ff;
      align-items: flex-start;
      gap: 6px;
      font-size: 0.7rem;
    }

    .hour-label {
      color: var(--text-soft);
      font-weight: 500;
    }

    .hour-events {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .hour-event-pill {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.7rem;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      white-space: nowrap;
    }

    /* ==== VISTA SEMANA ==== */

    .week-view-header {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .week-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 0.7rem;
    }

    .week-day-card {
      background: #fffafd;
      border-radius: 10px;
      border: 1px solid #f1d4ff;
      padding: 4px 5px 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 80px;
    }

    .week-day-title {
      font-weight: 600;
      font-size: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .week-day-title span.date {
      color: var(--text-soft);
      font-weight: 500;
      font-size: 0.7rem;
    }

    .week-events-list {
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-top: 2px;
    }

    .week-event-pill {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.68rem;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
<link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>

</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <header class="header">
      <div class="title-block">
        <div class="cat-logo">
          <div class="cat-inner">üê±</div>
        </div>
        <div class="title-text">
          <h1>Agenda Gatuna <span class="badge">hogar</span></h1>
          <div class="subtitle">Franjas continuas, turnos largos y noches de caos bonito üåà</div>
        </div>
      </div>

      <div class="header-right">
        <div class="month-nav">
          <button class="month-btn" id="prevBtn">‚óÄ</button>
          <div class="month-label" id="monthLabel"></div>
          <button class="month-btn" id="nextBtn">‚ñ∂</button>
        </div>
        <div class="view-nav">
          <button class="view-btn" id="viewTodayBtn">HOY</button>
          <button class="view-btn" id="viewWeekBtn">SEMANA</button>
          <button class="view-btn active" id="viewMonthBtn">MES</button>
        </div>
      </div>
    </header>

    <!-- FORMULARIO EVENTO -->
    <section class="event-form">
      <div class="event-form-title">
        <span class="cat">üò∫</span> Nuevo turno / evento
      </div>
      <div class="event-grid">
        <div class="field">
          <label for="titleInput">T√≠tulo</label>
          <input type="text" id="titleInput" placeholder="Ej: Noche 20‚Äì8, Libre, Veterinario">
        </div>

        <div class="field">
          <label>Color</label>
          <div class="color-palette" id="colorPalette"></div>
        </div>

        <div class="field">
          <label for="startInput">Inicio</label>
          <input type="datetime-local" id="startInput">
        </div>

        <div class="field">
          <label for="endInput">Fin</label>
          <input type="datetime-local" id="endInput">
        </div>
      </div>

      <div class="row-actions">
        <div class="chips">
          <div class="chip">üåô Turnos que cruzan medianoche</div>
          <div class="chip">üòº D√≠as libres, visitas, viajes</div>
        </div>
        <button class="btn-primary" id="addEventBtn">
          <span class="icon">‚ú®</span> Guardar evento
        </button>
      </div>
      <div class="form-hint">
        Las franjas se dibujan de forma continua entre d√≠as. El texto va centrado en toda la duraci√≥n del evento.
      </div>
    </section>

    <!-- CALENDARIO -->
    <section class="calendar-wrapper">
      <div id="calendarContainer"></div>
    </section>
  </div>

  <script>
    // ===== DATOS DE EJEMPLO =====
function enableLongPress(element) {
  let pressTimer;
  
  element.addEventListener("mousedown", startPress);
  element.addEventListener("touchstart", startPress);
  element.addEventListener("mouseup", cancelPress);
  element.addEventListener("mouseleave", cancelPress);
  element.addEventListener("touchend", cancelPress);

  function startPress(e) {
    pressTimer = setTimeout(() => {
      const eventId = element.dataset.eventId;
      openEventMenu(eventId);
    }, 600); // 600 ms = long press
  }

  function cancelPress() {
    clearTimeout(pressTimer);
  }
}

let selectedEventId = null;

function openEventMenu(id) {
  selectedEventId = id;
  document.getElementById("eventMenu").style.display = "block";
}

document.getElementById("cancelMenu").onclick = () => {
  document.getElementById("eventMenu").style.display = "none";
};

document.getElementById("deleteBtn").onclick = () => {
  events = events.filter(ev => ev.id !== selectedEventId);
  saveEvents();
  document.getElementById("eventMenu").style.display = "none";
  renderCurrentView();
};

document.getElementById("editBtn").onclick = () => {
  const ev = events.find(ev => ev.id === selectedEventId);
  if (!ev) return;

  // llenar formulario
  titleInput.value = ev.title;
  startInput.value = ev.start;
  endInput.value   = ev.end;
  selectedColor = ev.color;

  // marcar color en la paleta
  document.querySelectorAll('.color-swatch').forEach(sw => {
    if (sw.style.background === ev.color) sw.classList.add('selected');
    else sw.classList.remove('selected');
  });

  // eliminar evento antiguo
  events = events.filter(e => e.id !== ev.id);

  saveEvents();
  renderCurrentView();

  document.getElementById("eventMenu").style.display = "none";
};


let events = [];
// ---- Guardado en localStorage ----
function saveEvents() {
  localStorage.setItem("agendaGatunaEvents", JSON.stringify(events));
}

// ---- Cargar desde localStorage ----
function loadEvents() {
  const raw = localStorage.getItem("agendaGatunaEvents");
  if (!raw) return;
  try {
    const parsed = JSON.parse(raw);
    if (Array.isArray(parsed)) {
      events = parsed;
    }
  } catch (e) {
    console.error("Error al cargar eventos:", e);
  }
}

// Cargar eventos al iniciar
loadEvents();


    // ===== PALETA =====
    const pastelColors = [
      '#ff9eb5', '#ffc96b', '#b4f8c8', '#a0c4ff',
      '#ffadf0', '#ffd6a5', '#caffbf', '#9bf6ff',
      '#f1c0e8', '#ffafcc', '#c4b5fd', '#fbbf77',
      '#8ec5fc', '#a5b4fc', '#9ca3af', '#f97373'
    ];

    let selectedColor = pastelColors[0];
    const colorPaletteEl = document.getElementById('colorPalette');

    function renderColorPalette() {
      colorPaletteEl.innerHTML = '';
      pastelColors.forEach((c, idx) => {
        const sw = document.createElement('div');
        sw.classList.add('color-swatch');
        sw.style.background = c;
        if (idx === 0) sw.classList.add('selected');
        sw.addEventListener('click', () => {
          selectedColor = c;
          document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
          sw.classList.add('selected');
        });
        colorPaletteEl.appendChild(sw);
      });
    }

    // ===== UTILIDADES FECHA =====
    const today = new Date();
    let currentDate = new Date(today);  // ancla para mes/semana/d√≠a
    let currentView = 'month';          // 'day' | 'week' | 'month'

    const monthNames = [
      'Enero','Febrero','Marzo','Abril','Mayo','Junio',
      'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'
    ];

    const weekdayShort = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];

    const monthLabel = document.getElementById('monthLabel');
    const calendarContainer = document.getElementById('calendarContainer');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    const viewTodayBtn = document.getElementById('viewTodayBtn');
    const viewWeekBtn  = document.getElementById('viewWeekBtn');
    const viewMonthBtn = document.getElementById('viewMonthBtn');

    function parseDateTime(str) {
      return new Date(str);
    }

    function stripTime(date) {
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function formatTime(date) {
      const h = String(date.getHours()).padStart(2, '0');
      const m = String(date.getMinutes()).padStart(2, '0');
      return `${h}:${m}`;
    }

    function toLocalInputString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const mins = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${mins}`;
    }

    function getContrastColor(hex) {
      if (!hex) return '#ffffff';
      let c = hex.replace('#','');
      if (c.length === 3) c = c.split('').map(ch => ch + ch).join('');
      const r = parseInt(c.substr(0,2),16);
      const g = parseInt(c.substr(2,2),16);
      const b = parseInt(c.substr(4,2),16);
      const yiq = (r*299 + g*587 + b*114) / 1000;
      return yiq >= 180 ? '#333333' : '#ffffff';
    }

    function darkenColor(hex, amount = 0.25) {
      let c = hex.replace('#','');
      if (c.length === 3) c = c.split('').map(ch => ch + ch).join('');
      let r = parseInt(c.substr(0,2),16);
      let g = parseInt(c.substr(2,2),16);
      let b = parseInt(c.substr(4,2),16);
      r = Math.max(0, Math.min(255, Math.floor(r * (1 - amount))));
      g = Math.max(0, Math.min(255, Math.floor(g * (1 - amount))));
      b = Math.max(0, Math.min(255, Math.floor(b * (1 - amount))));
      return '#' + r.toString(16).padStart(2,'0') +
                   g.toString(16).padStart(2,'0') +
                   b.toString(16).padStart(2,'0');
    }

    function sameDay(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    // ==== VISTA MES ====
    function renderMonthView() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      calendarContainer.innerHTML = '';

      monthLabel.textContent = monthNames[month] + ' ' + year;

      const weekdayRow = document.createElement('div');
      weekdayRow.className = 'weekday-row';
      weekdayShort.forEach(w => {
        const d = document.createElement('div');
        d.textContent = w;
        weekdayRow.appendChild(d);
      });

      const calendarGrid = document.createElement('div');
      calendarGrid.className = 'calendar-grid';

      const overlaysContainer = document.createElement('div');
      overlaysContainer.className = 'month-overlays';

      calendarContainer.appendChild(weekdayRow);
      calendarContainer.appendChild(calendarGrid);
      calendarContainer.appendChild(overlaysContainer);

      const firstDayOfMonth = new Date(year, month, 1);
      let startDay = (firstDayOfMonth.getDay() + 6) % 7; // lunes=0
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const totalCells = 42;
      let dayNumber = 1;
      let nextMonthDay = 1;

      const prevMonth = (month === 0) ? 11 : month - 1;
      const prevYear = (month === 0) ? year - 1 : year;
      const daysInPrevMonth = new Date(prevYear, prevMonth + 1, 0).getDate();

      const cellByDate = {};

      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement('div');
        cell.classList.add('day-cell');

        let cellDate;
        let isCurrentMonth = false;

        if (i < startDay) {
          const d = daysInPrevMonth - (startDay - 1 - i);
          cellDate = new Date(prevYear, prevMonth, d);
          cell.classList.add('empty-day');
        } else if (dayNumber > daysInMonth) {
          const nextM = (month === 11) ? 0 : month + 1;
          const nextY = (month === 11) ? year + 1 : year;
          cellDate = new Date(nextY, nextM, nextMonthDay++);
          cell.classList.add('empty-day');
        } else {
          cellDate = new Date(year, month, dayNumber++);
          isCurrentMonth = true;
        }

        const dateKey = cellDate.toISOString().slice(0,10);
        if (isCurrentMonth) {
          cellByDate[dateKey] = cell;
        }
        cell.dataset.date = dateKey;

        const dayHeader = document.createElement('div');
        dayHeader.classList.add('day-header');

        const dayNumberEl = document.createElement('div');
        dayNumberEl.classList.add('day-number');
        dayNumberEl.textContent = cellDate.getDate();

        const kittyEl = document.createElement('div');
        kittyEl.classList.add('day-kitty');
        if (isCurrentMonth) kittyEl.textContent = 'üêæ';

        dayHeader.appendChild(dayNumberEl);
        dayHeader.appendChild(kittyEl);
        cell.appendChild(dayHeader);

        if (sameDay(cellDate, today)) {
          const badge = document.createElement('div');
          badge.classList.add('today-badge');
          badge.textContent = 'HOY';
          cell.appendChild(badge);
        }

        const dayEvents = document.createElement('div');
        dayEvents.classList.add('day-events');
        cell.appendChild(dayEvents);

        calendarGrid.appendChild(cell);
      }

      // Overlays multi-d√≠a
      requestAnimationFrame(() => buildMonthOverlays(cellByDate, calendarGrid, overlaysContainer));
    }

    function buildMonthOverlays(cellByDate, calendarGrid, overlaysContainer) {
      overlaysContainer.innerHTML = '';
      const gridRect = calendarGrid.getBoundingClientRect();

      events.forEach(ev => {
        const s = parseDateTime(ev.start);
        const e = parseDateTime(ev.end);

        const startDate = stripTime(s);
        const endDate   = stripTime(e);

        let firstCellRect = null;
        let lastCellRect  = null;

        let cur = new Date(startDate);
        while (cur <= endDate) {
          const key = cur.toISOString().slice(0,10);
          const cell = cellByDate[key];
          if (cell) {
            const r = cell.getBoundingClientRect();
            if (!firstCellRect) firstCellRect = r;
            lastCellRect = r;
          }
          cur = addDays(cur, 1);
        }

        if (!firstCellRect || !lastCellRect) return;

        const bar = document.createElement('div');
        bar.classList.add('overlay-event');

        const baseColor   = ev.color || '#ff9eb5';
        const darkerColor = darkenColor(baseColor, 0.35);

        bar.style.background = `linear-gradient(90deg, ${baseColor} 0%, ${darkerColor} 100%)`;
        bar.style.color = getContrastColor(baseColor);

        const label = `${formatTime(parseDateTime(ev.start))} a ${formatTime(parseDateTime(ev.end))}` +
                      (ev.title ? ` ¬∑ ${ev.title}` : '');
        bar.textContent = label;

        const left  = firstCellRect.left - gridRect.left + 4;
        const right = lastCellRect.right - gridRect.left - 4;
        const top   = firstCellRect.top - gridRect.top + 32;

        bar.style.left   = left + 'px';
        bar.style.width  = (right - left) + 'px';
        bar.style.top    = top + 'px';
        bar.style.height = '36px';

        overlaysContainer.appendChild(bar);
bar.dataset.eventId = ev.id;
enableLongPress(bar);

      });
    }

    // ==== VISTA D√çA (HOY) ====
    function getEventsForDay(dateObj) {
      const startDay = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 0, 0, 0);
      const endDay   = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 24, 0, 0);
      return events.filter(ev => {
        const s = parseDateTime(ev.start);
        const e = parseDateTime(ev.end);
        return e > startDay && s < endDay;
      });
    }

    function renderDayView() {
      const d = stripTime(currentDate);
      const year = d.getFullYear();
      const month = d.getMonth();
      const day = d.getDate();

      calendarContainer.innerHTML = '';

      monthLabel.textContent = `${day} ${monthNames[month]} ${year}`;

      const header = document.createElement('div');
      header.className = 'day-view-header';
      header.innerHTML = `Agenda del d√≠a <span class="badge-day">vista 24 horas</span>`;

      const hoursWrapper = document.createElement('div');
      hoursWrapper.className = 'day-hours';

      const dayEvents = getEventsForDay(d);

      for (let h = 0; h < 24; h++) {
        const row = document.createElement('div');
        row.className = 'hour-row';

        const label = document.createElement('div');
        label.className = 'hour-label';
        label.textContent = `${String(h).padStart(2,'0')}:00`;

        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'hour-events';

        const hourStart = new Date(year, month, day, h, 0, 0);
        const hourEnd   = new Date(year, month, day, h+1, 0, 0);

        dayEvents.forEach(ev => {
          const s = parseDateTime(ev.start);
          const e = parseDateTime(ev.end);
          if (e > hourStart && s < hourEnd) {
            const pill = document.createElement('div');
            pill.className = 'hour-event-pill';
            pill.style.background = ev.color || '#ff9eb5';
            pill.style.color = getContrastColor(ev.color || '#ff9eb5');
            pill.textContent = `${formatTime(s)}‚Äì${formatTime(e)} ¬∑ ${ev.title}`;
            eventsContainer.appendChild(pill);
pill.dataset.eventId = ev.id;
enableLongPress(pill);

          }
        });

        row.appendChild(label);
        row.appendChild(eventsContainer);
        hoursWrapper.appendChild(row);
      }

      calendarContainer.appendChild(header);
      calendarContainer.appendChild(hoursWrapper);
    }

    // ==== VISTA SEMANA ====
    function getWeekRange(anchorDate) {
      const dayOfWeek = (anchorDate.getDay() + 6) % 7; // lunes=0
      const monday = addDays(stripTime(anchorDate), -dayOfWeek);
      const sunday = addDays(monday, 6);
      return { monday, sunday };
    }

    function renderWeekView() {
      calendarContainer.innerHTML = '';

      const { monday, sunday } = getWeekRange(currentDate);

      const sameMonth = monday.getMonth() === sunday.getMonth();
      let labelText;
      if (sameMonth) {
        labelText = `${monday.getDate()}‚Äì${sunday.getDate()} ${monthNames[monday.getMonth()]} ${monday.getFullYear()}`;
      } else {
        labelText = `${monday.getDate()} ${monthNames[monday.getMonth()]} ‚Äì ${sunday.getDate()} ${monthNames[sunday.getMonth()]} ${monday.getFullYear()}`;
      }
      monthLabel.textContent = labelText;

      const header = document.createElement('div');
      header.className = 'week-view-header';
      header.textContent = 'Semana en vista compacta';

      const grid = document.createElement('div');
      grid.className = 'week-grid';

      for (let i = 0; i < 7; i++) {
        const dayDate = addDays(monday, i);
        const card = document.createElement('div');
        card.className = 'week-day-card';

        const title = document.createElement('div');
        title.className = 'week-day-title';
        const name = weekdayShort[i];
        const dateSpan = document.createElement('span');
        dateSpan.className = 'date';
        dateSpan.textContent = `${dayDate.getDate()}/${String(dayDate.getMonth()+1).padStart(2,'0')}`;

        const nameSpan = document.createElement('span');
        nameSpan.textContent = name;

        title.appendChild(nameSpan);
        title.appendChild(dateSpan);

        if (sameDay(dayDate, today)) {
          const hoy = document.createElement('span');
          hoy.textContent = 'HOY';
          hoy.style.fontSize = '0.6rem';
          hoy.style.marginLeft = '4px';
          hoy.style.padding = '1px 4px';
          hoy.style.borderRadius = '999px';
          hoy.style.background = '#a0c4ff';
          hoy.style.color = '#fff';
          title.appendChild(hoy);
        }

        const list = document.createElement('div');
        list.className = 'week-events-list';

        const evs = getEventsForDay(dayDate);
        evs.sort((a,b) => parseDateTime(a.start) - parseDateTime(b.start));

        evs.forEach(ev => {
          const s = parseDateTime(ev.start);
          const e = parseDateTime(ev.end);
          const pill = document.createElement('div');
          pill.className = 'week-event-pill';
          pill.style.background = ev.color || '#ff9eb5';
          pill.style.color = getContrastColor(ev.color || '#ff9eb5');
          pill.textContent = `${formatTime(s)}‚Äì${formatTime(e)} ¬∑ ${ev.title}`;
          list.appendChild(pill);
pill.dataset.eventId = ev.id;
enableLongPress(pill);

        });

        card.appendChild(title);
        card.appendChild(list);
        grid.appendChild(card);
      }

      calendarContainer.appendChild(header);
      calendarContainer.appendChild(grid);
    }

    // ==== CAMBIO DE VISTA Y NAVEGACI√ìN ====
    function highlightView(mode) {
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      if (mode === 'day') viewTodayBtn.classList.add('active');
      if (mode === 'week') viewWeekBtn.classList.add('active');
      if (mode === 'month') viewMonthBtn.classList.add('active');
    }

    function renderCurrentView() {
      if (currentView === 'day') {
        renderDayView();
      } else if (currentView === 'week') {
        renderWeekView();
      } else {
        renderMonthView();
      }
    }

    prevBtn.addEventListener('click', () => {
      if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else if (currentView === 'week') {
        currentDate = addDays(currentDate, -7);
      } else {
        currentDate = addDays(currentDate, -1);
      }
      renderCurrentView();
    });

    nextBtn.addEventListener('click', () => {
      if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else if (currentView === 'week') {
        currentDate = addDays(currentDate, 7);
      } else {
        currentDate = addDays(currentDate, 1);
      }
      renderCurrentView();
    });

    viewTodayBtn.addEventListener('click', () => {
      currentView = 'day';
      currentDate = new Date(today);
      highlightView('day');
      renderCurrentView();
    });

    viewWeekBtn.addEventListener('click', () => {
      currentView = 'week';
      currentDate = new Date(today);
      highlightView('week');
      renderCurrentView();
    });

    viewMonthBtn.addEventListener('click', () => {
      currentView = 'month';
      currentDate = new Date(today);
      highlightView('month');
      renderCurrentView();
    });

    // ===== FORM =====
    const titleInput = document.getElementById('titleInput');
    const startInput = document.getElementById('startInput');
    const endInput   = document.getElementById('endInput');
    const addEventBtn = document.getElementById('addEventBtn');

    function initDefaultDateTimes() {
      const now = new Date();
      const in8h = new Date(now.getTime() + 8 * 60 * 60 * 1000);
      startInput.value = toLocalInputString(now);
      endInput.value   = toLocalInputString(in8h);
    }

    addEventBtn.addEventListener('click', () => {
      const title = titleInput.value.trim();
      const startVal = startInput.value;
      const endVal   = endInput.value;

      if (!startVal || !endVal) {
        alert('Define inicio y fin del evento üê±‚Äçüëì');
        return;
      }

      const start = parseDateTime(startVal);
      const end   = parseDateTime(endVal);

      if (start >= end) {
        alert('La hora de inicio debe ser menor a la de fin üïí');
        return;
      }

events.push({
  id: 'ev-' + Date.now(),
  title,
  start: startVal,
  end: endVal,
  color: selectedColor
});

// ‚¨ÖÔ∏è Muy importante guardar

saveEvents();
renderCurrentView();

    });

    // ===== INIT =====
    renderColorPalette();
    initDefaultDateTimes();
    highlightView('month');
    renderCurrentView();
  </script>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAkQPkCcTNxYBlVujUlHqcoiHmr7c_2l6M",
    authDomain: "agenda-gatuna-94913.firebaseapp.com",
    projectId: "agenda-gatuna-94913",
    storageBucket: "agenda-gatuna-94913.firebasestorage.app",
    messagingSenderId: "712244519104",
    appId: "1:712244519104:web:7c0da39b39e16f90744d25"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
<!-- MENU FLOTANTE PARA EDITAR/ELIMINAR -->
<div id="eventMenu" class="event-menu" style="
  display:none;
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%, -50%);
  background:white;
  padding:14px;
  border-radius:14px;
  box-shadow:0 6px 20px rgba(0,0,0,0.15);
  z-index:9999;
  width: 220px;
  text-align:center;
  font-family:'Poppins';
">
  <div style="margin-bottom:10px; font-weight:600;">Opciones del evento</div>
  <button id="editBtn" style="width:100%; padding:6px 10px; border:none; border-radius:10px; background:#a0c4ff; color:white; margin-bottom:6px; font-weight:600;">Editar</button>
  <button id="deleteBtn" style="width:100%; padding:6px 10px; border:none; border-radius:10px; background:#ff9eb5; color:white; margin-bottom:6px; font-weight:600;">Eliminar</button>
  <button id="cancelMenu" style="width:100%; padding:6px 10px; border:none; border-radius:10px; background:#ddd; font-weight:600;">Cancelar</button>
</div>

</body>
</html>


